<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.boards.board.DAO.BoardRepository">

    <select id="getBoards" resultType="org.example.boards.board.Entity.Board">
        SELECT BOARD.BOARD_ID AS boardId, BOARD.WRITER,
               CASE
                   WHEN CREATE_DATE IS NULL THEN '-'
                   ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                   END AS createDate,
               CASE
                   WHEN UPDATE_DATE IS NULL THEN '-'
                   ELSE DATE_FORMAT(UPDATE_DATE, '%Y-%m-%d')
                   END AS updateDate,
               BOARD.TITLE,
               CATEGORY.NAME AS CATEGORY,
               BOARD.CONTENT
        FROM BOARD
        INNER JOIN CATEGORY ON CATEGORY.CD = BOARD.CATEGORY
        WHERE CREATE_DATE &gt;= #{headDate}
          AND CREATE_DATE &lt;= #{tailDate}
          AND (TITLE LIKE CONCAT('%',#{searchWord},'%')
               OR CONTENT LIKE CONCAT('%',#{searchWord},'%')
               OR WRITER LIKE CONCAT('%',#{searchWord},'%'))
        <if test="category!=null and category != 0">
            AND BOARD.CATEGORY = #{category}
        </if>
    </select>

    <select id="getCategories" resultType="org.example.boards.board.Entity.Category">
        SELECT CD, NAME FROM CATEGORY;
    </select>

    <select id="isRealBoard" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="getBoard" resultType="org.example.boards.board.Entity.Board">
        SELECT
            BOARD.BOARD_ID as boardId,
            BOARD.TITLE,
            CATEGORY.NAME AS CATEGORY,
            BOARD.WRITER,
            BOARD.VIEWS,
            CASE
                WHEN CREATE_DATE IS NULL THEN '-'
                ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                END AS createDate,
            CASE
                WHEN UPDATE_DATE IS NULL THEN '-'
                ELSE DATE_FORMAT(UPDATE_DATE, '%Y-%m-%d')
                END AS updateDate,
            BOARD.CONTENT
        FROM BOARD
        INNER JOIN CATEGORY ON CATEGORY.CD = BOARD.CATEGORY
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="getComments" resultType="org.example.boards.board.Entity.Comment">
        SELECT
                COMMENT_ID as commentId,
                CONTENT,
                WRITER,
                CASE
                    WHEN CREATE_DATE IS NULL THEN '-'
                    ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                END AS createDate
        FROM COMMENT
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="getFiles" resultType="org.example.boards.board.Entity.FileData">
        SELECT NAME, PATH, UUID
        FROM FILE
        WHERE BOARD_ID =  #{boardId}
    </select>

    <insert id="insertComment">
        INSERT INTO COMMENT (BOARD_ID, WRITER, CONTENT, CREATE_DATE)
        VALUES (#{boardId}, "테스트", #{content}, NOW())
    </insert>

    <delete id="deleteBoard">
        DELETE FROM BOARD WHERE BOARD_ID = #{boardId}
    </delete>

    <select id="checkPassword" resultType="int">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1
                    ELSE 0 END AS RESULT
        FROM BOARD
        WHERE BOARD_ID = #{boardId}
         AND PASSWORD = HEX(AES_ENCRYPT(#{password}, #{key}));
    </select>

    <update id="increaseViews">
        UPDATE BOARD
        SET VIEWS = VIEWS+1
        WHERE BOARD_ID = #{boardId}
    </update>

    <insert id="insertBoard" useGeneratedKeys="true" keyProperty="board.boardId" >
        INSERT INTO BOARD (
            TITLE, CONTENT, CREATE_DATE,
            WRITER, CATEGORY, PASSWORD
        )
        VALUES (
                   #{board.title}, #{board.content}, NOW(),
                   #{board.writer}, #{board.category}, HEX(AES_ENCRYPT(#{board.password}, #{key}))
               )
    </insert>

    <insert id="insertFiles" parameterType="java.util.List">
        INSERT INTO FILE (
                           NAME, PATH, UUID, BOARD_ID
        ) VALUES
              <foreach collection="files" item="file"  separator="," >
                  (#{file.name}, #{file.path}, #{file.uuid}, #{file.boardId})
              </foreach>
    </insert>

    <select id="getMaxBoardId" resultType="int">
        SELECT BOARD_ID
        FROM BOARD
        ORDER BY BOARD_ID DESC
        LIMIT 1
    </select>

</mapper>