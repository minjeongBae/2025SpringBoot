<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.boards.board.DAO.BoardRepository">

    <select id="getBoards" resultType="org.example.boards.board.Entity.Board">
        SELECT BOARD.BOARD_ID AS boardId, BOARD.WRITER,
               CASE
                   WHEN CREATE_DATE IS NULL THEN '-'
                   ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                   END AS createDate,
               CASE
                   WHEN UPDATE_DATE IS NULL THEN '-'
                   ELSE DATE_FORMAT(UPDATE_DATE, '%Y-%m-%d')
                   END AS updateDate,
               BOARD.TITLE,
               CATEGORY.NAME AS CATEGORY,
               BOARD.CONTENT
        FROM BOARD
        INNER JOIN CATEGORY ON CATEGORY.CD = BOARD.CATEGORY
        WHERE CREATE_DATE <![CDATA[>=]]> IFNULL(#{headDate}, '2000-01-01')
          AND CREATE_DATE <![CDATA[<=]]> IFNULL(#{tailDate}, '9999-01-01')
          AND (TITLE LIKE CONCAT('%',IFNULL(#{searchWord}, ''),'%')
               OR CONTENT LIKE CONCAT('%',IFNULL(#{searchWord}, ''),'%')
               OR WRITER LIKE CONCAT('%',IFNULL(#{searchWord}, ''),'%'));
    </select>

    <select id="getCategories" resultType="org.example.boards.board.Entity.Category">
        SELECT CD, NAME FROM CATEGORY;
    </select>

    <select id="isRealBoard" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="getBoard" resultType="org.example.boards.board.Entity.Board">
        SELECT
            BOARD.BOARD_ID as boardId,
            BOARD.TITLE,
            CATEGORY.NAME AS CATEGORY,
            BOARD.WRITER,
            BOARD.VIEWS,
            CASE
                WHEN CREATE_DATE IS NULL THEN '-'
                ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                END AS createDate,
            CASE
                WHEN UPDATE_DATE IS NULL THEN '-'
                ELSE DATE_FORMAT(UPDATE_DATE, '%Y-%m-%d')
                END AS updateDate,
            BOARD.CONTENT
        FROM BOARD
        INNER JOIN CATEGORY ON CATEGORY.CD = BOARD.CATEGORY
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="getComments" resultType="org.example.boards.board.Entity.Comment">
        SELECT
                COMMENT_ID as commentId,
                CONTENT,
                WRITER,
                CASE
                    WHEN CREATE_DATE IS NULL THEN '-'
                    ELSE DATE_FORMAT(CREATE_DATE, '%Y-%m-%d')
                END AS createDate
        FROM COMMENT
        WHERE BOARD_ID = #{boardId}
    </select>

    <insert id="insertComment">
        INSERT INTO COMMENT (BOARD_ID, WRITER, CONTENT, CREATE_DATE)
        VALUES (#{boardId}, "테스트", #{content}, NOW())
    </insert>

    <insert id="insertBoard">
        INSERT INTO BOARD (WRITER, CONTENT, CREATE_DATE, TITLE, CATEGORY)
        VALUES (#{writer}, #{content}, NOW(), #{title}, #{category})
    </insert>

    <delete id="deleteBoard">
        DELETE FROM BOARD WHERE BOARD_ID = #{boardId};
    </delete>

    <select id="checkPassword" resultType="String">
        SELECT CASE WHEN COUNT(1) > 0 THEN 'Y'
                    ELSE 'N' END AS RESULT
        FROM USER
        WHERE PASSWORD = HEX(AES_ENCRYPT(#{password}, #{key}));
    </select>

    <update id="increaseViews">
        UPDATE BOARD
        SET VIEWS = VIEWS+1
        WHERE BOARD_ID = #{boardId}
    </update>
</mapper>